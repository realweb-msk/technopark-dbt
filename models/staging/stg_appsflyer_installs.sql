WITH a_is AS (
    SELECT
        DATE(install_time) AS `date`,
        attributed_touch_type, 
        attributed_touch_time, 
        install_time, 
        event_time, 
        event_name, 
        event_value, 
        event_revenue, 
        event_revenue_currency, 
        event_revenue_usd, 
        event_source, 
        is_receipt_validated, 
        partner, 
        media_source, 
        channel, 
        keywords, 
        campaign, 
        campaign_id, 
        adset, 
        adset_id, 
        ad, 
        ad_id, 
        ad_type, 
        site_id, 
        sub_site_id, 
        sub_param_1, 
        sub_param_2, 
        sub_param_3, 
        sub_param_4, 
        sub_param_5, 
        cost_model, 
        cost_value, 
        cost_currency, 
        contributor_1_partner, 
        contributor_1_media_source, 
        contributor_1_campaign, 
        contributor_1_touch_type, 
        contributor_1_touch_time, 
        contributor_2_partner, 
        contributor_2_media_source, 
        contributor_2_campaign, 
        contributor_2_touch_type, 
        contributor_2_touch_time, 
        contributor_3_partner, 
        contributor_3_media_source, 
        contributor_3_campaign, 
        contributor_3_touch_type, 
        contributor_3_touch_time, 
        region, 
        country_code, 
        state, 
        city, 
        postal_code, 
        dma, 
        ip, 
        wifi, 
        operator, 
        carrier, 
        language, 
        appsflyer_id, 
        advertising_id, 
        idfa, 
        android_id, 
        customer_user_id, 
        imei, 
        idfv, 
        platform, 
        device_type, 
        os_version, 
        app_version, 
        sdk_version, 
        app_id, 
        app_name, 
        bundle_id, 
        is_retargeting, 
        retargeting_conversion_type, 
        attribution_lookback, 
        reengagement_window, 
        is_primary_attribution, 
        user_agent, 
        http_referrer, 
        original_url, 
        device_model
    FROM  {{ source('AppsFlyer', 'android_installs_airflow') }}
),

i_is AS (
    SELECT
        DATE(install_time) AS `date`,
        attributed_touch_type, 
        attributed_touch_time, 
        install_time, 
        event_time, 
        event_name, 
        event_value, 
        event_revenue, 
        event_revenue_currency, 
        event_revenue_usd, 
        event_source, 
        is_receipt_validated, 
        partner, 
        media_source, 
        channel, 
        keywords, 
        campaign, 
        campaign_id, 
        adset, 
        adset_id, 
        ad, 
        ad_id, 
        ad_type, 
        site_id, 
        sub_site_id, 
        sub_param_1, 
        sub_param_2, 
        sub_param_3, 
        sub_param_4, 
        sub_param_5, 
        cost_model, 
        cost_value, 
        cost_currency, 
        contributor_1_partner, 
        contributor_1_media_source, 
        contributor_1_campaign, 
        contributor_1_touch_type, 
        contributor_1_touch_time, 
        contributor_2_partner, 
        contributor_2_media_source, 
        contributor_2_campaign, 
        contributor_2_touch_type, 
        contributor_2_touch_time, 
        contributor_3_partner, 
        contributor_3_media_source, 
        contributor_3_campaign, 
        contributor_3_touch_type, 
        contributor_3_touch_time, 
        region, 
        country_code, 
        state, 
        city, 
        postal_code, 
        dma, 
        ip, 
        wifi, 
        operator, 
        carrier, 
        language, 
        appsflyer_id, 
        advertising_id, 
        idfa, 
        android_id, 
        customer_user_id, 
        imei, 
        idfv, 
        platform, 
        device_type, 
        os_version, 
        app_version, 
        sdk_version, 
        app_id, 
        app_name, 
        bundle_id, 
        is_retargeting, 
        retargeting_conversion_type, 
        attribution_lookback, 
        reengagement_window, 
        is_primary_attribution, 
        user_agent, 
        http_referrer, 
        original_url, 
        device_model
    FROM  {{ source('AppsFlyer', 'ios_installs_airflow') }}
    
),

a_ris AS (
    SELECT
        DATE(install_time) AS `date`,
        attributed_touch_type, 
        attributed_touch_time, 
        install_time, 
        event_time, 
        event_name, 
        event_value, 
        event_revenue, 
        event_revenue_currency, 
        event_revenue_usd, 
        event_source, 
        is_receipt_validated, 
        partner, 
        media_source, 
        channel, 
        keywords, 
        campaign, 
        campaign_id, 
        adset, 
        adset_id, 
        ad, 
        ad_id, 
        ad_type, 
        site_id, 
        sub_site_id, 
        sub_param_1, 
        sub_param_2, 
        sub_param_3, 
        sub_param_4, 
        sub_param_5, 
        cost_model, 
        cost_value, 
        cost_currency, 
        contributor_1_partner, 
        contributor_1_media_source, 
        contributor_1_campaign, 
        contributor_1_touch_type, 
        contributor_1_touch_time, 
        contributor_2_partner, 
        contributor_2_media_source, 
        contributor_2_campaign, 
        contributor_2_touch_type, 
        contributor_2_touch_time, 
        contributor_3_partner, 
        contributor_3_media_source, 
        contributor_3_campaign, 
        contributor_3_touch_type, 
        contributor_3_touch_time, 
        region, 
        country_code, 
        state, 
        city, 
        postal_code, 
        dma, 
        ip, 
        wifi, 
        operator, 
        carrier, 
        language, 
        appsflyer_id, 
        advertising_id, 
        idfa, 
        android_id, 
        customer_user_id, 
        imei, 
        idfv, 
        platform, 
        device_type, 
        os_version, 
        app_version, 
        sdk_version, 
        app_id, 
        app_name, 
        bundle_id, 
        is_retargeting, 
        retargeting_conversion_type, 
        attribution_lookback, 
        reengagement_window, 
        is_primary_attribution, 
        user_agent, 
        http_referrer, 
        original_url, 
        device_model
    FROM  {{ source('AppsFlyer', 'android_retargeting_conversions_airflow') }}
),

i_ris AS (
    SELECT
        DATE(install_time) AS `date`,
        attributed_touch_type, 
        attributed_touch_time, 
        install_time, 
        event_time, 
        event_name, 
        event_value, 
        event_revenue, 
        event_revenue_currency, 
        event_revenue_usd, 
        event_source, 
        is_receipt_validated, 
        partner, 
        media_source, 
        channel, 
        keywords, 
        campaign, 
        campaign_id, 
        adset, 
        adset_id, 
        ad, 
        ad_id, 
        ad_type, 
        site_id, 
        sub_site_id, 
        sub_param_1, 
        sub_param_2, 
        sub_param_3, 
        sub_param_4, 
        sub_param_5, 
        cost_model, 
        cost_value, 
        cost_currency, 
        contributor_1_partner, 
        contributor_1_media_source, 
        contributor_1_campaign, 
        contributor_1_touch_type, 
        contributor_1_touch_time, 
        contributor_2_partner, 
        contributor_2_media_source, 
        contributor_2_campaign, 
        contributor_2_touch_type, 
        contributor_2_touch_time, 
        contributor_3_partner, 
        contributor_3_media_source, 
        contributor_3_campaign, 
        contributor_3_touch_type, 
        contributor_3_touch_time, 
        region, 
        country_code, 
        state, 
        city, 
        postal_code, 
        dma, 
        ip, 
        wifi, 
        operator, 
        carrier, 
        language, 
        appsflyer_id, 
        advertising_id, 
        idfa, 
        android_id, 
        customer_user_id, 
        imei, 
        idfv, 
        platform, 
        device_type, 
        os_version, 
        app_version, 
        sdk_version, 
        app_id, 
        app_name, 
        bundle_id, 
        is_retargeting, 
        retargeting_conversion_type, 
        attribution_lookback, 
        reengagement_window, 
        is_primary_attribution, 
        user_agent, 
        http_referrer, 
        original_url, 
        device_model
    FROM  {{ source('AppsFlyer', 'ios_retargeting_conversions_airflow') }}

),

unions AS (
    SELECT * FROM a_is
    UNION ALL
    SELECT * FROM i_is
    UNION ALL
    SELECT * FROM a_ris
    UNION ALL
    SELECT * FROM i_ris
),

final AS (
    SELECT
        `date`,
        attributed_touch_type, 
        DATETIME(attributed_touch_time) AS attributed_touch_time, 
        DATETIME(install_time) AS install_time, 
        DATETIME(event_time) AS event_time, 
        event_name, 
        event_value, 
        SAFE_CAST(event_revenue AS FLOAT64) event_revenue, 
        event_revenue_currency, 
        SAFE_CAST(event_revenue_usd AS FLOAT64) event_revenue_usd, 
        event_source, 
        is_receipt_validated, 
        partner, 
        media_source, 
        channel, 
        keywords, 
        campaign, 
        campaign_id, 
        adset, 
        adset_id, 
        ad, 
        ad_id, 
        ad_type, 
        site_id, 
        sub_site_id, 
        sub_param_1, 
        sub_param_2, 
        sub_param_3, 
        sub_param_4, 
        sub_param_5, 
        cost_model, 
        cost_value, 
        cost_currency, 
        contributor_1_partner, 
        contributor_1_media_source, 
        contributor_1_campaign, 
        contributor_1_touch_type, 
        contributor_1_touch_time, 
        contributor_2_partner, 
        contributor_2_media_source, 
        contributor_2_campaign, 
        contributor_2_touch_type, 
        contributor_2_touch_time, 
        contributor_3_partner, 
        contributor_3_media_source, 
        contributor_3_campaign, 
        contributor_3_touch_type, 
        contributor_3_touch_time, 
        region, 
        country_code, 
        state, 
        city, 
        postal_code, 
        dma, 
        ip, 
        wifi, 
        operator, 
        carrier, 
        language, 
        appsflyer_id, 
        advertising_id, 
        idfa, 
        android_id, 
        customer_user_id, 
        imei, 
        idfv, 
        platform, 
        device_type, 
        os_version, 
        app_version, 
        sdk_version, 
        app_id, 
        app_name, 
        bundle_id, 
        SAFE_CAST(is_retargeting AS BOOL) AS is_retargeting, 
        retargeting_conversion_type, 
        attribution_lookback, 
        reengagement_window, 
        SAFE_CAST(is_primary_attribution AS BOOL) AS is_primary_attribution,
        user_agent, 
        http_referrer, 
        original_url, 
        device_model 
    FROM unions
)

SELECT 
    `date`,
    attributed_touch_type, 
    attributed_touch_time, 
    install_time, 
    event_time, 
    event_name, 
    event_value, 
    event_revenue, 
    event_revenue_currency, 
    event_revenue_usd, 
    event_source, 
    is_receipt_validated, 
    partner, 
    media_source, 
    channel, 
    keywords, 
    campaign, 
    campaign_id, 
    adset, 
    adset_id, 
    ad, 
    ad_id, 
    ad_type, 
    site_id, 
    sub_site_id, 
    sub_param_1, 
    sub_param_2, 
    sub_param_3, 
    sub_param_4, 
    sub_param_5, 
    cost_model, 
    cost_value, 
    cost_currency, 
    contributor_1_partner, 
    contributor_1_media_source, 
    contributor_1_campaign, 
    contributor_1_touch_type, 
    contributor_1_touch_time, 
    contributor_2_partner, 
    contributor_2_media_source, 
    contributor_2_campaign, 
    contributor_2_touch_type, 
    contributor_2_touch_time, 
    contributor_3_partner, 
    contributor_3_media_source, 
    contributor_3_campaign, 
    contributor_3_touch_type, 
    contributor_3_touch_time, 
    region, 
    country_code, 
    state, 
    city, 
    postal_code, 
    dma, 
    ip, 
    wifi, 
    operator, 
    carrier, 
    language, 
    appsflyer_id, 
    advertising_id, 
    idfa, 
    android_id, 
    customer_user_id, 
    imei, 
    idfv, 
    platform, 
    device_type, 
    os_version, 
    app_version, 
    sdk_version, 
    app_id, 
    app_name, 
    bundle_id, 
    is_retargeting, 
    retargeting_conversion_type, 
    attribution_lookback, 
    reengagement_window, 
    is_primary_attribution, 
    user_agent, 
    http_referrer, 
    original_url, 
    device_model
FROM final